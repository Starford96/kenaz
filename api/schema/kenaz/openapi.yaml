openapi: "3.1.0"
info:
  title: Kenaz API
  description: Local-first knowledge base with Markdown storage, full-text search, and graph visualization.
  version: "1.0.0"

servers:
  - url: /api
    description: Default (relative)

security:
  - bearerAuth: []

paths:
  /notes:
    get:
      operationId: listNotes
      summary: List notes with optional pagination and filtering.
      parameters:
        - name: limit
          in: query
          schema: { type: integer }
        - name: offset
          in: query
          schema: { type: integer }
        - name: tag
          in: query
          schema: { type: string }
        - name: sort
          in: query
          schema: { type: string, enum: [updated_at, title, path] }
      responses:
        "200":
          description: Paginated list of notes.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NoteListResponse"
    post:
      operationId: createNote
      summary: Create a new note.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateNoteRequest"
      responses:
        "201":
          description: Note created.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NoteDetail"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          $ref: "#/components/responses/Conflict"

  /notes/{path}:
    get:
      operationId: getNote
      summary: Get a single note by path.
      parameters:
        - $ref: "#/components/parameters/NotePath"
      responses:
        "200":
          description: Note detail.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NoteDetail"
        "404":
          $ref: "#/components/responses/NotFound"
    put:
      operationId: updateNote
      summary: Update a note (supports optimistic concurrency via If-Match).
      parameters:
        - $ref: "#/components/parameters/NotePath"
        - name: If-Match
          in: header
          description: SHA-256 checksum for optimistic concurrency control.
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateNoteRequest"
      responses:
        "200":
          description: Note updated.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NoteDetail"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
    delete:
      operationId: deleteNote
      summary: Delete a note.
      parameters:
        - $ref: "#/components/parameters/NotePath"
      responses:
        "204":
          description: Note deleted.
        "404":
          $ref: "#/components/responses/NotFound"

  /search:
    get:
      operationId: searchNotes
      summary: Full-text search across notes.
      parameters:
        - name: q
          in: query
          required: true
          schema: { type: string }
        - name: limit
          in: query
          schema: { type: integer }
      responses:
        "200":
          description: Search results.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SearchResponse"
        "400":
          $ref: "#/components/responses/BadRequest"

  /graph:
    get:
      operationId: getGraph
      summary: Get the knowledge graph (nodes and links).
      responses:
        "200":
          description: Graph data.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GraphResponse"

  /attachments:
    post:
      operationId: uploadAttachment
      summary: Upload an attachment file.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
      responses:
        "201":
          description: Attachment uploaded.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AttachmentResponse"
        "400":
          $ref: "#/components/responses/BadRequest"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer

  parameters:
    NotePath:
      name: path
      in: path
      required: true
      description: Relative path to the note (e.g. folder/note.md).
      schema: { type: string }

  responses:
    BadRequest:
      description: Bad request.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    NotFound:
      description: Resource not found.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Conflict:
      description: Conflict (duplicate or checksum mismatch).
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string

    NoteListItem:
      type: object
      required: [path, title, checksum, tags, updated_at]
      properties:
        path:
          type: string
        title:
          type: string
        checksum:
          type: string
        tags:
          type: array
          items: { type: string }
        updated_at:
          type: string
          format: date-time

    NoteDetail:
      type: object
      required: [path, title, content, checksum, tags, backlinks, updated_at]
      properties:
        path:
          type: string
        title:
          type: string
        content:
          type: string
        checksum:
          type: string
        tags:
          type: array
          items: { type: string }
        frontmatter:
          type: object
          additionalProperties: true
          nullable: true
        backlinks:
          type: array
          items: { type: string }
        updated_at:
          type: string
          format: date-time

    NoteListResponse:
      type: object
      required: [notes, total]
      properties:
        notes:
          type: array
          items:
            $ref: "#/components/schemas/NoteListItem"
        total:
          type: integer

    CreateNoteRequest:
      type: object
      required: [path, content]
      properties:
        path:
          type: string
        content:
          type: string

    UpdateNoteRequest:
      type: object
      required: [content]
      properties:
        content:
          type: string

    SearchResult:
      type: object
      required: [path, title, snippet]
      properties:
        path:
          type: string
        title:
          type: string
        snippet:
          type: string

    SearchResponse:
      type: object
      required: [results]
      properties:
        results:
          type: array
          items:
            $ref: "#/components/schemas/SearchResult"

    GraphNode:
      type: object
      required: [id]
      properties:
        id:
          type: string
        title:
          type: string

    GraphLink:
      type: object
      required: [source, target]
      properties:
        source:
          type: string
        target:
          type: string

    GraphResponse:
      type: object
      required: [nodes, links]
      properties:
        nodes:
          type: array
          items:
            $ref: "#/components/schemas/GraphNode"
        links:
          type: array
          items:
            $ref: "#/components/schemas/GraphLink"

    AttachmentResponse:
      type: object
      required: [filename, size, url]
      properties:
        filename:
          type: string
        size:
          type: integer
        url:
          type: string
